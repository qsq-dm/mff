<!doctype html>
<html lang="en" view_count={{question.view_count}} is_myself={{is_myself}}>

	<head>
		<meta charset="UTF-8" />
		{% if 0 %}
		<title>“测一测我的隐私值多少钱?”  快来看看我的答案</title>
		{% else %}
        <title>“{{question.question}}” 点击看答案!</title>
		{% endif %}
        <link rel="stylesheet" href="/static/user/css/loading.css" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="/static/user/css/mui.css" />
		<link rel="stylesheet" type="text/css" href="/static/user/redpack/css/common.css" />
	</head>
	<style type="text/css">
		html,
		body {
			min-height: 100%;
			background: #ff3a41;
			padding-bottom: 10px;
		}
		
		.mui-content {
			background: #ff3a41;
		}
		
		.warp {
			margin: 10px 10px 0;
			background: #fff0ff;
			box-sizing: border-box;
			padding: 10px;
			border-radius: 5px;
			position: relative;
		}
		
		.warp .box {
			border: 2px solid #ff3a41;
			box-sizing: border-box;
			padding: 10px;
			border-radius: 5px;
		}
		
		.line {
			/*border-top:1px dashed red;*/
			margin-top: 10px;
			background: url(/static/user/redpack/images/line.png) no-repeat 0 center, url(/static/user/redpack/images/line.png) no-repeat right center;
			text-align: center;
			background-size: 32%;
			color: #FF3A41;
		}
		
		.list li {
			line-height: 40px;
			margin-bottom: 10px;
			text-align: left;
		}
		
		.list li img {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			vertical-align: middle;
		}
		
		.list li .ml {
			margin-left: 10px;
		}
		
		.problem {
			/*background: url(images/iocn-rigth.png) no-repeat right center;*/
			background-size: auto 20px;
			color: #ff3a41;
		}
		
		.problem h4 {
			color: #ff3a41;
			font-weight: bold;
			font-size: 16px;
			text-align: center;
			margin-top: 20px;
		}
		
		.problem span {
			margin-left: 5px;
		}
		
		.btn {
			text-align: center;
		}
		
		.btn button {
			width: 40%;
			display: block;
			margin: 0 auto;
		}
		
		.header img {
			width: 100%;
		}
		
		.bg {
			position: absolute;
			top: -30px;
			left: 50%;
			margin-left: -30px;
		}
		
		.bg img {
			width: 60px;
			height: 60px;
			border-radius: 50%;
		}
		
		.img {
			margin-top: 20px;
		}
		
		.img img {
			width: 100%;
		}
		
		.foot {
			background: url(/static/user/redpack/images/button-yellow.png) no-repeat 0 0;
			background-size: 100% 100%;
			color: red;
			border: none;
			width: 60%;
			margin: 10px auto;
		}
		
		.tit {
			text-align: center;
			padding: 20px 0;
			color: #ccc;
		}
		
		#chakan {
		}
		
		.content {
			padding-top: 20px;
			padding-bottom: 15px;
		}
		
		.list .pad {
			box-sizing: border-box;
			padding: 0 10px;
			margin: 0;
		}
		
		.list .pad img {
			width: 30px;
			height: 30px;
			border-radius: 50%;
		}
		
		.list-pop {
			max-height: 300px;
			overflow-y: scroll;
		}
		
		.red_drop {
			box-sizing: border-box;
			padding: 0 10px;
			position: relative;
		}
		
		.red_drop .pic {
			position: absolute;
			width: 50px;
			height: 50px;
			border-radius: 50%;
			background: url(/static/user/redpack/images/drop-raduis.png) no-repeat 0 0;
			background-size: 100% 100%;
			top: 18%;
			left: 50%;
			margin-left: -25px;
			padding: 5px;
		}
		
		.red_drop img {
			width: 100%;
		}
		
		.text {
			width: 100%;
			position: absolute;
			top: 40%;
			text-align: center;
			left: 0;
			color: #fff;
		}
		
		.text p {
			color: #fff;
		}
		
		.text p span {
			font-size: 30px;
		}
		
		.mui-backdrop {
			display: none;
		}
		
		#open {
			display: block;
			line-height: 40px;
			text-align: center;
			width: 50%;
			margin: 10px auto;
			color: #fff;
			background: url(/static/user/redpack/images/button-red.png) no-repeat 0 0;
			background-size: 100% 100%;
		}
		.poin{
			width: 80%;
			/*margin:10px auto;*/
			display: none;
			position: absolute;
			top:5%;
			margin-left: -40%;
			left: 50%;
			}
			.content .img{
				top:-60px;
			}
			.to-friend {
                width: 35%;
                float: left;
                margin-left: 10%;
            }
            .to-create {
                width: 35%;
                float: left;
                margin-left: 10%;
            }
         
         @media only screen and (max-height:480px) {
            .to-friend {
                font-size: 14px !important;
            }
            .to-create {
                font-size: 14px !important;
            }
         }
	</style>

	<body>
	   <div id='loader' class="loader-inner ball-pulse" style='z-index:10000; text-align: center;display:none;position: fixed;width:100%;top:45%;'>
              <div></div>
              <div></div>
              <div></div>
        </div>
		<div class="mui-content">
			<div class="header">
				<img src="/static/user/redpack/images/start_redpack.jpg" alt="" />
			</div>
{% if is_myself %}
			<div class="warp">
				<div class="bg">
					<img src="{{creator.headimgurl}}" alt="" />
				</div>
				<div class="box">
					<div class="problem">

						<h4>{{question.question}}</h4>
        				<div>答案:<span>{{question.answer}}</span></div>
        				{% if question.is_random %}
                            <div>红包:<span>随机</span></div>
        				{% else %}
        				    <div>红包:<span>{{question.price}}元</span></div>
        				{% endif %}
        			      			
        		</div>
        		<div class="line">
        			<span class="count">{{question.view_count}}</span>人查看答案
        		</div>
        		<ul class="list" id="first">
        			<!--<li>
        				<img src="images/header_pic.png" alt="" />
        				<span class="ml">托马斯</span>
        				<span class="fr">2.8元</span>
        			</li>
        			<li>
        				<img src="images/header_pic.png" alt="" />
        				<span class="ml">托马斯</span>
        				<span class="fr">2.8元</span>
        			</li>-->
        		</ul>
        		{% if question.view_count==0 %}
        		    <div class="tit">暂无收到红包</div>
        		{% endif %}
        		{% if question.view_count>2 %}
        			<div class="btn">
        				<button class="mui-btn mui-btn-danger" id="genduo">查看更多</button>
               		</div>
                {% endif %}
        	 </div>
{% else %}
            <div class="warp">
                <div class="bg">
                    <img src="{{creator.headimgurl}}" alt="" />
                </div>
                <div class="box">
                    <div class="problem" style='padding-bottom:15px;'>

                        <h4>{{question.question}}</h2>
                                    
                </div>
                <div class="line">
                    答案
                </div>
                {% if has_viewed %}
                <div class='problem'>
                        <h4>{{question.answer}}</h4>
                </div>
                {% else %}
                    <div class="btn" style='padding:10px;'>                        
                        <button class="mui-btn mui-btn-danger" id="chakan">查看答案</button>
                     </div>
                {% endif %}
                </div>
             </div>
{% endif %}

       		 </div>
       		 <div class="img">
       		 	<img src="/static/user/redpack/images/text.png" alt="" />
       		 </div>
                <button class="mui-btn mui-btn-block foot to-friend">转发好友收红包</button>
                <button class="mui-btn mui-btn-block foot to-create">我也要收红包</button>
       		<!-- 蒙版-->
       		    <div class="mui-backdrop">
       		    	<img src="/static/user/redpack/images/mark-icon.png" class="poin" alt="" />
		       		<div class="content">  
		       			<img src="/static/user/redpack/images/icon-houzi.png" alt="" class="img" />
		       			<span class="close"></span>
		       			<ul class="list list-pop">
		       				<!--<li class="pad">
		        				<img src="/static/user/redpack/images/header_pic.png" alt="" />
		        				<span class="ml size-sm">托马斯</span>
		        				<span class="fr size-sm">2.8元</span>
		        			</li>-->
		       			</ul>
		       			<div class="red_drop" style="display: block;">
		       				<img src="/static/user/redpack/images/drop-bg.png" alt="" />
		       				<div class="pic">
		       					<img src="{{creator.headimgurl}}" alt="" style='border-radius:20px;' />
		       					
		       				</div>
		       				<div class="text">
		       						<p><span id='redpack-price'></span>元</p>
		       						<span>红包到，答案到</span>
		       				</div>
		       				<div class="btn">
		       					<span id="open">发个红包，看答案</span>
		       				</div>
		       			</div>
		       		</div>
		       	</div> 
   		    </div>
    <script src="/static/user/js/mui.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/user/js/jquery.min.js"></script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="http://www.meifenfen.com/user/jssdk.js"></script>
    <script src="/static/user/js/util.js"></script>
    <script type="text/javascript">
    mui.init();
    var para=Common.UrlGet();

$(document).ready(function(){

	$.ajax({
		xhrFields: {withCredentials: true},
		type: "post",
		url: "http://" + getHostName() + "/user/question_viewers/",
		dataType: 'json',
		data: {
			user_question_id:para.user_question_id										
		},
		success: function(data) {
			var infos=data.infos;
			
			if(infos.length<2){
				$('#genduo').hide();
			}
			if(infos.length==0){
				$('.tit').show();
			};
			for(var i=0;i<infos.length;i++){
				if(i==2){
					break;
				}
				var str='<li><img src="'+infos[i].qr_user.headimgurl+'" alt="" /><span class="ml">'+infos[i].qr_user.nickname+'</span><span class="fr">'+infos[i].price+'元</span></li>'
				$('#first').append(str);
			}
			
			for(var i=0;i<infos.length;i++){
				var str='<li class="pad"><img src="'+infos[i].qr_user.headimgurl+'" alt="" /><span class="ml">'+infos[i].qr_user.nickname+'</span><span class="fr">'+infos[i].price+'元</span></li>'
				$('.list-pop').append(str);
			};
			$('.count').html(infos.length);
			
		},
		error: function(){
			
		}
	});
	$('.close').on('click',function(){
    	$('.mui-backdrop').hide()
    })
    $('#genduo').on('click',function(){
    	$('.mui-backdrop').show();
    	$('.red_drop').hide();
    	$('.list-pop').show();
    	$('.poin').hide();
    	$('.content').show();
    });
	$('.to-friend').on('click',function(){
		$('.mui-backdrop').show();
		$('.poin').show();
		$('.content').hide();
	});
	$('.to-create').on('click',function(){
        window.location = '/user/redpack_index/';
    });
    window.pay_data = undefined;

    function refresh_pay_data (callback) {
        $('#loader').show()
        $.ajax({

             type: 'GET',
        
             url: '/user/redpack_pay/'+location.search ,
                        
             success: function (data) {
                $('#loader').hide()
                if(data.code!=0) {
                    alert(data.msg);
                    return window.location=location
                } else {
                    window.pay_data = data;
                    if(callback) {
                        callback()
                    }
                };
            } ,
        
            dataType: 'json'
        
        });
    };


	$('#chakan').on('click',function(){
		function callback(data) {
		    $('.mui-backdrop').show();
            $('.content').show();
            $('.red_drop').show();
            $('.list-pop').hide();
            data = data || window.pay_data;
		    $('#redpack-price').html(data.question.price);
		}
		if(!window.pay_data) {
            refresh_pay_data(callback);
        } else {
            callback()
        }
        
	});
	$('.mui-backdrop').on('click',function(){
		$('.mui-backdrop').hide();
        $('.poin').hide();
	})


	$.fn.serializeObject = function()
        {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };
      function payWechat(params){
            WeixinJSBridge.invoke(
             'getBrandWCPayRequest', {
                 "appId" : params.appId,     //公众号名称，由商户传入     
                 "timeStamp": params.timeStamp,         //时间戳，自1970年以来的秒数     
                 "nonceStr" : params.nonceStr, //随机串     
                 "package" : params.package,     
                 "signType" : params.signType,         //微信签名方式:     
                 "paySign" : params.paySign //微信签名 
             },
            function(res){    
                a = JSON.stringify(res)
                //alert(a);
                if(res.err_msg == "get_brand_wcpay_request:ok" ){
                  //alert('支付成功');
                  window.location = '/user/question_detail/'+location.search;
                  return true;
                }else(res.err_msg=='get_brand_wcpay_request:cancel' || res.err_msg=='get_brand_wcpay_request:fail')
                {
                  //alert('未支付成功')
                  return false
                }
            }
         ); 
      }
	$('#open').click(function() {
	    if(window.pay_data) {
	       payWechat(window.pay_data.params);
	    } else {
	       refresh_pay_data(payWechat);
	    }
    })


    wx.ready(function(){
        wx.onMenuShareTimeline({
    
            {% if 0 %}
            title: '“测一测我的隐私值多少钱” 红包到，答案到', // 分享标题
            {% else %}
            title: '“{{question.question}}” 点击看答案!', // 分享标题
            {% endif %}

            link: 'http://www.meifenfen.com' + window.location.pathname+window.location.search, // 分享链接
    
            imgUrl: '{{creator.headimgurl}}', // 分享图标
    
            success: function () {
    
                console.log('success')
    
                // 用户确认分享后执行的回调函数
    
            },
    
            cancel: function () {
    
                console.log('cancel')
    
                // 用户取消分享后执行的回调函数
    
            }
    
        });
    
        wx.onMenuShareAppMessage({
    
            {% if 0 %}
            title: '“测一测我的隐私值多少钱” 红包到，答案到', // 分享标题
            {% else %}
            title: '“{{question.question}}” 点击看答案!', // 分享标题
            {% endif %}
    
            desc: '所有大学生都在使用的收红包神器。\n\n美分分 出品', // 分享描述
    
            link: 'http://www.meifenfen.com' + window.location.pathname+window.location.search, // 分享链接
    
            imgUrl: '{{creator.headimgurl}}', // 分享图标
    
            success: function () {
    
                console.log('success')
    
                // 用户确认分享后执行的回调函数
    
            },
    
            cancel: function () {
    
                console.log('cancel')
    
                // 用户取消分享后执行的回调函数
    
            }
    
        });
    
    });
    //refresh_pay_data();

})

    </script>
</body>
</html>