<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="format-detection" content="telephone=no" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>美分分寝室设计大赛</title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/tab-header.css" />
		<link rel="stylesheet" href="css/style.css?version=1" />
		<link rel="stylesheet" href="../css/swiper.min.css" />
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript" charset="UTF-8">
			mui.init();
			//			document.documentElement.style.fontSize = document.documentElement.clientWidth / 37.5 + 'px';
		</script>
		<style>
			.swiper-container img {
				display: block;
			}
			
			.swiper-container {
				width: 95%;
			}
			
			@media only screen and (max-width: 320px) {
				.banner .search {
					bottom: 15% !important;
				}
				.banner .search span {
					margin-right: 3% !important;
				}
				.contianer{
					margin-top: -20px !important;
				}
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div class="banner">
				<img src="images/big-back-bg.jpg" alt="" />
				<div class="search">
					<input type="text" placeholder="输入手机号、队名或编号" />
					<span id="search"></span>
				</div>
			</div>
			<div class="contianer">
				<div id="segmentedControl" class="mui-segmented-control">
					<a class="mui-control-item mui-active" href="#item1mobile">
						<p>最新参与</p>
					</a>
					<a class="mui-control-item" href="#item2mobile">
						<p>全部排名</p>
					</a>
					<a class="mui-control-item" href="#item3mobile">
						<p>各校风采</p>
					</a>
				</div>
				<div class="mui-content-padded">
					<div id="item1mobile" class="mui-control-content mui-active">

						<!--<div class="noCoupon" style="text-align: center;">
							<img src="../img/icon-no-repay.png" style="width: 20%;margin-top: 50px;">
							<p>暂无试用</p>
							<p>美分分，为你加分，大学生分期去整形</p>
						</div>-->

						<div class="content">
						</div>
						<div class="itt">
							<span class="school-new"></span>
						</div>
					</div>
					<div id="item2mobile" class="mui-control-content">
						<!--<div class="noCoupon" style="text-align: center;">
							<img src="../img/icon-no-repay.png" style="width: 20%;margin-top: 50px;">
							<p>暂无试用</p>
							<p>美分分，为你加分，大学生分期去整形</p>
						</div>-->
						<div class="content">
						</div>
						<div class="itt">
							<span class="school-all"></span>
						</div>
					</div>
					<div id="item3mobile" class="mui-control-content">
						<!--<div class="noCoupon" style="text-align: center;">
							<img src="../img/icon-no-repay.png" style="width: 20%;margin-top: 50px;">
							<p>暂无试用</p>
							<p>美分分，为你加分，大学生分期去整形</p>
						</div>-->
						<ul class="tab">
							<!--<li class="fl">
								<p>上海师范大学</p>
								<span class="bg size-sm">233张</span>
								<span class="size-sm">闺房照</span>
							</li>
							<li class="fl">
								<p>上海师范大学</p>
								<span class="bg size-sm">233张</span>
								<span class="size-sm">闺房照</span>
							</li>
							<li class="fl">
								<p>上海师范大学</p>
								<span class="bg size-sm">233张</span>
								<span class="size-sm">闺房照</span>
							</li>
							<li class="fl">
								<p>上海师范大学</p>
								<span class="bg size-sm">233张</span>
								<span class="size-sm">闺房照</span>
							</li>-->
						</ul>
						<div class="itt">
							<span id="school-more"></span>
						</div>
					</div>
				</div>

				<img src="images/foot-bg.jpg" alt="" style="width: 100%;" class="posi" />
			</div>
			<div class="swiper-container swiper-container-horizontal">
				<div class="swiper-wrapper">
				    <div class="swiper-slide swiper-slide-active" style="width: 100%;">
                        <img onclick='location="http://www.meifenfen.com/static/user/Activities/banner1.html"'
                          src="http://7xnpdb.com2.z0.glb.qiniucdn.com/o_1acqfl9gh1vma5b2fnt1sui150211456882764343.jpg" width="100%" />
                    </div>
					<div class="swiper-slide swiper-slide-active" style="width: 100%;">
						<img onclick='location="http://wap.yestar1992.cn/article/article_28.html "'
						  src="http://7xnpdb.com2.z0.glb.qiniucdn.com/o_1acm8dt4p10gm9fe1njm1n9c1vtm11456740985050.jpg" width="100%" />
					</div>
					<div class="swiper-slide swiper-slide-active" style="width: 100%;">
						<img onclick='location="http://static.idongme.com/index.html"' 
						  src="http://7xnpdb.com2.z0.glb.qiniucdn.com/o_1acm8dt4p10gm9fe1njm1n9c1vtm11456741017781.jpg" width="100%" />
					</div>
					<div class="swiper-slide swiper-slide-active" style="width: 100%;">
                        <img onclick='location="http://www.mixiuer.cn"' 
                          src="http://7xnpdb.com2.z0.glb.qiniucdn.com/o_1aco140fa18uljmo17f23cvvu111456800410183.jpg" width="100%" />
                    </div>
				</div>
				<!-- Add Pagination -->
				<div class="swiper-pagination swiper-pagination-tapable">
					<span class="swiper-pagination-bullet"></span>
				</div>
			</div>
			<div class="rule">
				<h3>活动说明</h3>
			</div>
			<ul class="list">
				<li class="redcolr">【活动时间】</li>
				<li>拉票时间：2016.03.01 12:00～2016.03.30 12:00
					<br /> 颁奖日期：2016.03.30 12:00～2016.03.31 12:00
				</li>

				<li class="redcolr">【活动方式】</li>
				<li>1、活动仅限上海高校在读女生参与，报名成功后请通过微信分享给朋友进行投票。</br>
					2、活动截止后将于2016.03.31 10:00公布获奖名单和排名
				</li>

				<li class="redcolr">【参与方式】</li>
				<li>步骤一：关注“美分分”微信公众号，并用手机号注册
					<br /> 步骤二：点击朋友所分享链接，或通过美分分首页海报进入活动页面
					<br /> 步骤三：填写报名信息并上传寝室美照参与投票
					<br /> 步骤四：现在可以呼唤你的小伙伴出动为你投票啦 小美最喜欢伺候诚实的小主了，刷票的你走开！
				</li>
				<li class="redcolr">【投票规则】</li>
				<li>
					1、在投票截止日期前可通过分享链接，搜索手机号、编号和寝室花名参与投票
					<br /> 2、每人每天有一次投票机会（关注美分分微信公众号并注册即可投票）
					<br /> 3、凡在美分分公众号上，成功申请额度者1票相当于20票；预约分期整形并成功整形者1票相当于200票,每人只有一次机会
				</li>
				<li class="redcolr">【奖品设定】</li>
				<li>
					［最高人气奖］<br /> 奖项名额3名，由累计得票数排名前3名的寝室获得  <br />奖品：2000元现金红包+寝室每人200元美分分现金抵用券 <br />
					［最佳创意奖］<br />  奖项名额3名，由主办方从累计得票数排名前50名的寝室中选取 <br /> 奖品：800元现金红包+寝室每人200元现金抵用券 <br />
					［十佳最美寝室］<br /> 奖项名额10名，由大众评审团从累计得票数排名前20名的寝室中选取（大众评审团由主协办方代表和各校学生代表共同组成） <br />
					奖品：500元现金红包+寝室每人100元现金抵用券 <br />
					［最美寝室入围奖］<br />  奖项名额50名，累计得票数排名前50名的寝室均可获得<br />
					奖品：价值300元寝室大礼包+寝室每人100元现金抵用卷 <br />
					［美分分参与奖］ <br />
					 奖项名额不限名额，凡成功上传寝室照片的寝室均可获得 <br />奖品：价值80元寝室大礼包+寝室每人50元现金抵用券
				</li>
				<li class="redcolr">
					注：每组参赛寝室只有一次获奖机会，如同时满足两项获奖条件，则以获得的最高奖项为准<br />
					所有奖项仅限上海在校女大学生寝室获取，其他一经发现取消获奖资格。 
				</li>
				<li>
					<p style="text-align: center;margin-top:3px;">活动最终解释权归美分分所有</p>
				</li>
			</ul>

		</div>
		<nav class="mui-bar mui-bar-tab">
			<a class="mui-tab-item mui-active" id="canyu" href="sign_up.html">
				<span class="mui-tab-label icon"></span>
				<span class="mui-tab-label">我要参与</span>

			</a>
			<a class="mui-tab-item mui-active" id="prize" href="jpgl.html">
				<span class="mui-tab-label icon gift"></span>
				<span class="mui-tab-label">获奖攻略</span>
			</a>
		</nav>
		<div class="mui-backdrop">
			<div class="from alert" id="ulit">
				<div class="header">
					提示
					<span class="close"></span>
				</div>
				<section>
					<p>你要见的小主还没来呢！</p>
				</section>
			</div>
			<div class="from alert" id="not_found">
				<div class="header">
					提示
					<span class="close"></span>
				</div>
				<section>
					<p>你要见的小主还没来呢！</p>
				</section>
			</div>
			<div class="from alert" id="login">
				<div class="header">
					提示
					<span class="close"></span>
				</div>
				<section>
					<p>小主需要先登录才可以投票！</p>
					<button id="go_login">去登录</button>
				</section>
			</div>
			<div class="from vote-alert">
				<div class="header">
					投票小妙招
					<span class="close"></span>
				</div>
				<section>
					<p>投票期间申请额度通过，就会收到小美送出的一次20票的投票机会哦！</p>
					<button id="apply-ed">去申请额度</button>
					<div id="lines" class="ulit">
						<span class="fl">
							<img src="images/ok.png" alt="" />
							已获得
						</span>
						<span class="fr">已使用</span>
					</div>
					<p>投票期间完成一次分期整形就会收到小美送出的一次200票的投票机会哦</p>
					<button id="submit">去下单</button>
					<div id="success" class="ulit">
						<span class="fl">
							<img src="images/ok.png" alt="" />
							已获得
						</span>
						<span class="fr">已使用</span>
					</div>
					<p>直接投票，只计一票</p>
					<button id="zhijie">直接投票</button>
				</section>
			</div>
		</div>
		
		<script src="../js/jquery.min.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/swiper.min.js"></script>
		<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script type="text/javascript" src="http://www.meifenfen.com/user/jssdk.js"></script>
		<script>
			//轮播图
			var has_followed;// 是否关注
			$(document).ready(function() {
				var swiper = new Swiper('.swiper-container', {
					pagination: '.swiper-pagination',
					paginationtapable: true,
					autoplayDisableOnInteraction: false,
					autoplay: 3000,
					loop: true
				});
			});
			// 搜索接口
			showMask(0) //初始化;
			$('#search').on('tap', function() {
				var keyword = $('.search').find('input').val();
				$('.search').find('input').blur();
				if (!keyword.trim()) {
					alert('请输入手机号码或者编号');
					return;
				};
				$.ajax({
					xhrFields: {
						withCredentials: true
					},
					url: 'http://' + getHostName() + '/user/room_search/',
					type: 'post',
					dataType: 'json',
					data: {
						keyword: keyword
					},
					success: function(data) {
						if (data.room_exist) {
							location.href = 'room_details.html?room_id=' + data.room_id+'&shar=1'
						} else {
							$('.mui-backdrop').show();
							$('#not_found').show().siblings().hide();
							showMask(0);
						}
					},
					error: function() {
						alert('网络出现小差，请稍后再试');
					}
				});
			});
			//关闭浮层按钮;
			$(document).on('touchstart', '.close', function() {
				$('.mui-backdrop').hide();
				setTimeout(function() {
					showMask(1)
				}, 500);
				return false;
			});
			//底部跳转;
			$('#school-more').on('click', function() {
				location.href = 'gxfc.html';
			});
			$('.school-new').on('click', function() {
				sessionStorage.setItem('flga', 1);
				location.href = 'room_list.html';
			})
			$('.school-all').on('click', function() {
					sessionStorage.setItem('flga', 2);
					location.href = 'room_list.html';
				})
				//登录button
			$('#login button').on('tap', function() {
					location.href = '/static/user/login.html?next=' + location.href;
				})
				//申请额度
			$('#apply-ed').on('tap', function() {
				location.href = '/static/user/applyer-infor.html';
			});
			$('#submit').on('tap', function() {
				location.href = '/user/index';
			});
			//首页接口;
			$.ajax({
				xhrFields: {
					withCredentials: true
				},
				url: 'http://' + getHostName() + '/user/room_index/',
				type: 'post',
				dataType: 'json',
				success: function(data) {
					var third = data.third;
					my_room = data.my_room;
					has_followed=data.has_followed;
					if (data.has_attend) {
						$('#canyu').html('<span class="mui-tab-label icon" style="margin-right:5px;"></span><span class="mui-tab-label">我的参与</span>');
					} else {
						$('#canyu').html('<span class="mui-tab-label icon" style="margin-right:5px;"></span><span class="mui-tab-label">我要参与</span>');
					}
					//学校；
					$('#prize').on('tap', function() {
						if(!has_followed){
							location.href='/user/room_about/';
							return;
						}
						location.href = 'jpgl.html';
					});
					$('#canyu').on('tap', function() {
						
						if(!getCookie('sign_user')){
							$('.mui-backdrop').show();
							$('.mui-backdrop #login').show().siblings().hide();
							return false;
						}
						if(!has_followed){
							location.href='/user/room_about/';
							return;
						}
						if(!has_followed){
							location.href='/user/room_about/';
							return;
						}//
												
						if (data.has_attend) {
							location.href = 'room_details.html?room_id=' + my_room.id;
						} else {
							location.href = 'sign_up.html';
						}
						
					});
					for (var i = 0; i < third.length; i++) {
						var str = '\
						<li class="fl">\
							<a href="room_list.html?school_id=' + third[i].id + '">\
								<p class="mui-ellipsis">' + third[i].name + '</p>\
								<span class="bg size-sm">' + third[i].count + '张</span>\
								<span class="size-sm">闺房照</span>\
							</a>\
						</li>\
						';
						$('.tab').append(str);
					};
					$(document).on('click','.tab a',function(){
						var schoolName=$(this).find('p').text();
						
						sessionStorage.setItem('schoolName',schoolName);
					})
					
					var first = data.first;
					var second = data.second;

					function vone_list(id, name) {
						for (var x = 0; x < id.length; x++) {
							var chlid_str = '';
							if (id[x].thumb_pic_list.length == 4) {
								for (var k = 0; k < id[x].thumb_pic_list.length; k++) {
									if (id[x].thumb_pic_list[k]) {
										chlid_str += '<li><img class="img" src="' + id[x].thumb_pic_list[k] + '"><span></span></li>'
									} else {
										chlid_str += '<li><img class="img" src="images/room_s.jpg"><span></span></li>'
									}
								}
							} else {
								for (var k = 0; k < id[x].thumb_pic_list.length; k++) {
									chlid_str += '<li><img class="img" src="' + id[x].thumb_pic_list[k] + '"><span></span></li>'
								}
								chlid_str += '<li><img class="img" src="images/room_s.jpg"><span></span></li>'
							}
							var str_li = '<div class="fl float">\
							<div class="title">\
								<span class="mui-ellipsis">' + id[x].room_name + '</span>\
								<span class="mui-ellipsis">' + id[x].apply_no + '</span>\
							</div>\
							<div class="ranking">\
								<p>\
									排名<span>' + id[x].rank + '</span>\
								</p>\
								<p>\
									票数<span>' + id[x].vote_count + '</span>\
								</p>\
							</div>\
							<ul class="photo">\
								<a href="room_details.html?room_id=' + id[x].id + '&shar=1">' + chlid_str + '</a></ul>\
								<div class="txt">' + id[x].note + '</div>\
								<button class="btn vote-btn" cat-id="' + id[x].id + '">投票</button>\
							</div>\
							';
							$(name).append(str_li);
						}
					}
					vone_list(first, '#item1mobile .content')
					vone_list(second, '#item2mobile .content');
					var h=$('.photo li').width();
					$('.photo li img').height(h+'px');
						//调用
				},
				error: function() {
					alert('网络出现小差，请稍后再试')
				}
			});
			//点击投票按钮的代码
			$(document).on('tap', '.vote-btn', function() {
				console.log(has_followed);
				
				showMask(0); // 弹出蒙版的时候阻止事件穿透
				$('.vote-btn').removeClass('act');
				$(this).addClass('act');
				$('#not_found').hide();
				if (!getCookie('sign_user')) {
					$('.mui-backdrop').show();
					$('#login').show();
					$('.vote-alert').hide();
					$('#ulit').hide();
				} else {
					$('.mui-backdrop').show();
					$('.vote-alert').show();
					$('#login').hide();
					$('#ulit').hide();
				}; //--------------- 分割线
				if(!has_followed){
					location.href='/user/room_about/';
					return;
				};
				//查看权限接口；
				$.ajax({
					xhrFields: {
						withCredentials: true
					},
					url: 'http://' + getHostName() + '/user/get_vote_priviledges/',
					type: 'post',
					dataType: 'json',
					success: function(data) {
						var privileges = data.privileges;
						//点击直接投票的按钮的代码
						if (privileges[0].status == 0) {
							//0可以投票
							$('#lines').show();
							$('#lines .fr').html('可投票');
							$('#lines .fr').css('background-image', 'url(images/button.png)').addClass('can');
							$('#apply-ed').hide();
						} else if (privileges[0].status == 1) {
							//1已经投票
							$('#lines').show();
							$('#lines .fr').html('已投票');
							$('#lines .fr').css('background-image', 'url(images/disb.png)').removeClass('can');
							$('#apply-ed').hide();
						} else {
							//没权限快去申请
							$('#lines').hide();
						};
						//下单的按钮
						if (privileges[1].status == 0) {
							$('#success').show();
							$('#success .fr').html('可投票');
							$('#success .fr').css('background-image', 'url(images/button.png)').addClass('can');
							$('#submit').hide();
						} else if (privileges[1].status == 1) {
							$('#success').show();
							$('#success .fr').html('已投票');
							$('#success .fr').css('background-image', 'url(images/disb.png)').removeClass('can');
							$('#submit').hide();
						} else {
							$('#success').hide();
							$('#submit').show();
						};
						$('#lines .can').on('click', function() {
							touPiao(1);
						});
						$('#success .can').on('click', function() {
							touPiao(2);
						})
						$('#zhijie').off('tap'); //解除之前的绑定;
						$('#zhijie').on('tap', function() {
							if (privileges[2].status == 1) {
								$('.vote-alert').hide();
								$('#ulit').show();
								$('#ulit .header').html('投票失败 <span class="close"></span>	');
								$('#ulit p').html('小主一天只能投一次呢，明天可以再投哦！');
							} else {
								//还没投票请求投票接口;
								touPiao(3)
							}
						});
					}
				})
			});
			// 处理事件穿透;
			function showMask(v) {
				if (v) {
					$('.photo a').css('pointer-events', 'all');
				} else {
					$('.photo a').css('pointer-events', 'none');
				}
			};

			function touPiao(v) {
				var room_id = $('.btn.act').attr('cat-id');
				$.ajax({
					xhrFields: {
						withCredentials: true
					},
					url: 'http://' + getHostName() + '/user/vote_room/',
					type: 'post',
					dataType: 'json',
					data: {
						room_id: room_id,
						source: v
					},
					success: function(data) {
						alert(data.msg);
						if(data.code==0){
							location.href='';
						}
					},
					error: function() {
						alert('网络出现小差');
					}
				});
			};
			wx.ready(function() {
				wx.onMenuShareTimeline({
					title: '秀寝室颜值，赢2000元现金红包！', // 分享标题
					link: 'http://' + getHostName() + '/static/user/Activities/home.html', // 分享链接
					imgUrl:'http://www.meifenfen.com/static/user/Activities/images/propaganda.jpg', // 分享图标
					success: function() {
						console.log('success')
							// 用户确认分享后执行的回调函数
					},
					cancel: function() {
						console.log('cancel')
							// 用户取消分享后执行的回调函数
					}
				});
				wx.onMenuShareAppMessage({
					title: '“气质阁”or“颜值居”揭闺房之密，赢2000元现金红包！', // 分享标题
					link: 'http://' + getHostName() + '/static/user/Activities/home.html', // 分享链接
					imgUrl:'http://www.meifenfen.com/static/user/Activities/images/propaganda.jpg', // 分享图标     
					desc: '寝室是闺房，是要看气质和颜值的，哪位小主的闺房能用气质和颜值给美丽加分呢？', // 分享描述
					success: function() {
						console.log('success')
							// 用户确认分享后执行的回调函数
					},
					cancel: function() {
						console.log('cancel')
							// 用户取消分享后执行的回调函数
					}
				});
			});
		</script>
	</body>

</html>