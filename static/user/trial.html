<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>会员试用</title>
	<script src="/static/user/js/mui.min.js"></script>
	<link href="/static/user/css/mui.css" rel="stylesheet"/>
	<link rel="stylesheet" href="css/style.css" />
	<style type="text/css">
		.mui-segmented-control .mui-control-item.mui-active {
			color: #FF6565;
			background: #FFF;
			border-bottom: 2px solid #FF6565;
		}
		.mui-content{
			padding-bottom: 50px;
		}
		.mui-segmented-control {
			border: none;
			border-bottom: 1px solid #ECECEC;
			border-radius: 0;
			background: #FFF;
		}
		
		.mui-segmented-control .mui-control-item {
			border-left: none;
		}
		
		.mui-segmented-control .mui-control-item {
			color: #000;
		}
		.mui-table-view-cell.left,.mui-table-view-cell.right{
			/*width: 50%;*/
			height: 128px;
			position: relative;
			float: left;
			overflow: hidden;
			
		}
		.mui-table-view-cell.left{
			padding: 11px 0 0 11px;
			width: 35%;
		}
		.mui-table-view-cell.right{
			width: 65%;
		}
		.mui-table-view-cell.left img{
			width: 100%;
			/*max-width: 130px;*/
		}
		.mui-table-view-cell.right div{
			margin-top: 10px;
			color:#ababab;
		}
		.mui-table-view-cell.right h4{
			line-height: 20px;
			font-weight: 400;
			margin-top:0;
			display: -webkit-box;
			overflow: hidden;
			white-space: normal !important;
			text-overflow: ellipsis;
			word-wrap: break-word;
			-webkit-line-clamp: 1;
			-webkit-box-orient: vertical;
		}
		.mui-table-view-cell button{
			width: 50%;
			display: block;
			margin:15px auto;

			height: 40px;
			background: #dd524d;
			border:none;
			outline-color: none;
		}
		.mui-table-view-cell.w100{
			width: 100%;
		}
		i{
			font-style: normal;
			font-size:24px;
			font-weight: 400;
			margin-right: 10px;
		}
		div.mui-content-padded{
			margin:0;
			margin-top:10px;
		}
		.color-red{
			margin-left: 5px;
		}
		.mui-icon.index{
			background: url(/static/user/img/index0.png) no-repeat center center;
			background-size:100% 100%;
		}
		.mui-active .mui-icon.index{
			background: url(/static/user/img/index.png) no-repeat center center;
			background-size:100% 100%;			
		}
		.mui-icon.item{
			background: url(/static/user/img/item0.png) no-repeat center center;
			background-size:100% 100%;
		}
		.mui-active .mui-icon.item{
			background: url(/static/user/img/item.png) no-repeat center center;
			background-size:100% 100%;			
		}
		.mui-icon.wo{
			background: url(/static/user/img/wo0.png) no-repeat center center;
			background-size:100% 100%;
		}
		.mui-active .mui-icon.wo{
			background: url(/static/user/img/wo.png) no-repeat center center;
			background-size:100% 100%;			
		}
		nav.mui-bar-tab .mui-tab-item .mui-icon{
			top:5px;
			width: 18px;
			height: 18px;
		}
		ul.mui-table-view{
			overflow: hidden;
			margin-bottom: 10px;

			
		}
		ul.mui-table-view.act{
			background:#fff url(img/trial-act-img.png) no-repeat 95% 10%;
			background-size:auto 35%;
		}
		ul.mui-table-view.cur{
			background:#fff url(img/trial-img.png) no-repeat 95% 10%;
			background-size:auto 35%;
		}
		ul.mui-table-view:before{
			top:0;
		}
		span.color-black{
			margin-left:10px;
		}
		.mui-table-view-cell a.block{
			display: block;
			margin: 10px auto;
			background: #FF6565;
			width: 50%;
			color:#fff;
			border-radius: 3px;
			text-align: center;
			padding: 0;
			line-height: 40px;
		}			
	</style>
</head>
<body>
	<div class="mui-content">
		<div id="segmentedControl" class="mui-segmented-control">
			<a class="mui-control-item mui-active" href="#item1mobile">
				正在试用
			</a>
			<a class="mui-control-item" href="#item2mobile">
				往期试用
			</a>
			<a class="mui-control-item" href="#item3mobile">
				我的试用
			</a>
		</div>
		<div class="mui-content-padded">
			<div id="item1mobile" class="mui-control-content mui-active">
					<!--<ul class="mui-table-view" style="overflow: hidden;">
						<li class="mui-table-view-cell left no-after-line">
							<img src="img/ad-big-pic.png" alt="" />
						</li>
						<li class="mui-table-view-cell right no-after-line">
							<a >
								<h4>日本FaSoLa去黑头洁面仪洗脸神器</h4>
								<div>
									分数<i class="color-red">4</i> 人气<span class="color-black">150</span>
								</div>
								<div>
									费用<span class="color-black">包邮</span>
								</div>
								<div>剩余<span class="color-black">10天9时20分20秒</span></div>								
							</a>

						</li>
						<li class="mui-table-view-cell" style="padding-top:0;">
							<a class="block">立即申请</a>
						</li>
					</ul>-->
						<div class="noCoupon" style="text-align: center; display: none;">
								<img src="img/icon-no-repay.png" style="width: 20%;margin-top: 50px;">
								<p>暂无试用</p>
								<p>美分分，为你加分，大学生分期去整形</p>
						</div>						
				</div>
				<div id="item2mobile" class="mui-control-content ">
						<div class="noCoupon" style="text-align: center; display: none;">
								<img src="img/icon-no-repay.png" style="width: 20%;margin-top: 50px;">
								<p>暂无试用</p>
								<p>美分分，为你加分，大学生分期去整形</p>
						</div>	
				</div>
				<div id="item3mobile" class="mui-control-content">
						<div class="noCoupon" style="text-align: center; display: none;">
								<img src="img/icon-no-repay.png" style="width: 20%;margin-top: 50px;">
								<p>暂无试用</p>
								<p>美分分，为你加分，大学生分期去整形</p>
						</div>	
				</div>
			</div>		
			
		</div>
		<nav class="mui-bar mui-bar-tab">
			<a class="mui-tab-item" href="#mff" id='index'>
				<span class="mui-icon index">
					<!--<i class="iconfont">&#xe616;</i>-->
					<i class=''></i>
				</span>
				<span class="mui-tab-label">美分分</span>
			</a>
			<a class="mui-tab-item" href="#project" id='project'>
				<span class="mui-icon item">
					<!--<i class="iconfont">&#xe400;</i>-->
				</span>
				<span class="mui-tab-label">项目</span>
			</a>
			<a class="mui-tab-item mui-active" href="#project" id='trial'>
				<span class="mui-icon trial">
					<!--<i class="iconfont">&#xe400;</i>-->
				</span>
				<span class="mui-tab-label">免费试用</span>
			</a>			
			<a class="mui-tab-item " href="#me" id='me'>
				<span class="mui-icon wo">
					<!--<i class="iconfont">&#xe60e;</i>-->
				</span>
				<span class="mui-tab-label">我</span>
			</a>
		</nav>
		<script src='js/jquery.min.js'></script>
		<script src='js/util.js'></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript" src="http://www.meifenfen.com/user/jssdk.js"></script>
		<script>
//		$(document).on('click','#item1mobile .mui-btn-danger',function(){
//			location.href='trial-applyer.html?trial_id='+$(this).attr('data-id')
//		})
$('.mui-control-item').on('tap',function(){
	var index=$(this).index();
	 	location.hash='#1';
		if(index==2){
			if(!getCookie('sign_user')){
			location.href='login.html?next='+location.href+'?tab=3';
			}else{
				sessionStorage.setItem('tap-trial',index);
				$(this).addClass('mui-active').siblings().removeClass('mui-active');
				$('.mui-control-content').eq(index).addClass('mui-active').siblings().removeClass('mui-active');
			}
		}else{
			sessionStorage.setItem('tap-trial',index);
			$(this).addClass('mui-active').siblings().removeClass('mui-active');
			$('.mui-control-content').eq(index).addClass('mui-active').siblings().removeClass('mui-active');	
		}
//	sessionStorage.setItem('tap-trial',index);
//	$(this).addClass('mui-active').siblings().removeClass('mui-active');
//	$('.mui-control-content').eq(index).addClass('mui-active').siblings().removeClass('mui-active');
})
if(location.hash=='#10'){
	$('.mui-control-item').eq(0).trigger('tap')
}else{
	if (sessionStorage.getItem('tap-trial')==1) {
		$('.mui-control-item').eq(1).trigger('tap');
	}else if(sessionStorage.getItem('tap-trial')==2){
		$('.mui-control-item').eq(2).trigger('tap');
	}
	if(Common.UrlGet().tab==3){
		$('.mui-control-item').eq(2).trigger('tap');
	}
}

//导航页面跳转
$('#index').on('tap',function(){
	location.href='/user/index/'
})
$('#project').on('tap',function(){
	location.href='/static/user/project.html#10'
})
$('#me').on('tap',function(){
	location.href='/static/user/my-not-reg.html'
});
$('#trial').on('tap',function(){
	location.href='/static/user/trial.html#10'
})
var has_more1;
var offset1=undefined;
var has_more2;
var offset2=undefined;
var has_more3;
var offset3=undefined;
//$('.mui-control-item').eq(2).on('tap',function(){
//	if(!getCookie('sign_user')){
//		location.href='login.html?next='+location.href
//	}
//})
function getAjax(cat,id,tab,offset){
	if(offset){
		var Url="http://"+getHostName()+"/user/trial_list/?cat="+cat+"&offset="+offset
	}else{
		var Url="http://"+getHostName()+"/user/trial_list/?cat="+cat
	}
	$.ajax({
		xhrFields: {withCredentials: true},
		type:"get",
		url:Url,
		dataType:'json',
		success:function(data){
			var txt='';
			if(cat==1){
				has_more1=data.has_more;
				offset1=data.offset;
			}else if(cat==2){
				has_more2=data.has_more;
				offset2=data.offset;						
			}
			var infos=data.infos;
			if(infos.length==0 && offset==undefined){
				$(id).find('.noCoupon').show();
			}
			for(var i=0;i<infos.length;i++){
				switch (tab){
					case 'tab1':
					txt='<a class="block" href="trial-detail.html?trial_id='+infos[i].id+'#1">立即申请</a>'
					break;
					case 'tab2':
					txt='<a class="block" href="trial-detail.html?trial_id='+infos[i].id+'#1">查看试用体会</a>'
					break;								
					default:
					break;
				}						
				
				var str=$('<ul class="mui-table-view" style="overflow: hidden;"><li class="mui-table-view-cell left no-after-line"><img src="'+infos[i].image+'" alt=""></li><li class="mui-table-view-cell right no-after-line"><a href="trial-detail.html?trial_id='+infos[i].id+'#1"><h4>'+infos[i].title+'</h4><div>份数<i class="color-red">'+infos[i].total+'</i> 人气<span class="color-black">'+infos[i].apply_count+'</span></div><div>费用<span class="color-black">'+infos[i].cat_str+'</span></div><div>剩余<span class="color-black" id="'+tab+''+infos[i].id+'"></span></div></a></li><li class="mui-table-view-cell" style="padding-top:0;">'+txt+'</li></ul>');
				ding(infos[i].end_time,"#"+tab+infos[i].id)
				$(id).append(str);
			}
			wx.ready(function(){
				
				wx.onMenuShareTimeline({
					
					        title:'一大波试用正在免费申请中...', // 分享标题
					        
					        link: 'http://'+getHostName()+'/static/user/trial.html', // 分享链接
					        
					        imgUrl:infos[0].image, // 分享图标
					        
					        success: function () {
					        	
					        	console.log('success')
					        	
					            // 用户确认分享后执行的回调函数
					            
					        },
					        
					        cancel: function () {
					        	
					        	console.log('cancel')
					        	
					            // 用户取消分享后执行的回调函数
					            
					        }
					        
					    });
				
				wx.onMenuShareAppMessage({
					        title:'一大波试用正在免费申请中，千万别错过哦！' , // 分享标题
					        link: 'http://'+getHostName()+'/static/user/trial.html', // 分享链接
					        imgUrl:infos[0].image, // 分享图标     
					        desc: '美容小神器、微整形项目，试用免费申请，快来领取！！！美分分，为你加分，大学分期去整形。', // 分享描述
					        success: function () {
					        	
					        	console.log('success')
					        	
					            // 用户确认分享后执行的回调函数
					            
					        },
					        
					        cancel: function () {
					        	
					        	console.log('cancel')
					        	
					            // 用户取消分享后执行的回调函数
					            
					        }
					        
					    });
				
			});							
},error:function(){
		//			alert()
	}
});
}
		//tab3
function getTab3() {
		if (offset3) {
			var Url = "http://" + getHostName() + "/user/my_trial_list/?offset=" + offset3
		} else {
			var Url = "http://" + getHostName() + "/user/my_trial_list/"
		}
		$.ajax({
			xhrFields: {
				withCredentials: true
			},
			type:"get",
			url:Url,
			dataType:'json',
			success:function(data){
				var infos=data.infos;
				var txt='';
				if(infos.length==0 && offset3==undefined){
					$('#item3mobile .noCoupon').show()
				}
				has_more3=data.has_more;
				offset3=data.offset;				
				for(var i=0;i<infos.length;i++){
					var trial=infos[i].trial;
					var status=infos[i].status
					var str=$('<ul class="mui-table-view" style="overflow: hidden;"><li class="mui-table-view-cell left no-after-line"><img src="'+trial.image+'" alt=""></li><li class="mui-table-view-cell right no-after-line"><a href="trial-detail.html?trial_id='+infos[i].trial_id+'#1"><h4>'+trial.title+'</h4><div>份数<i class="color-red">'+trial.total+'</i> 人气<span class="color-black">'+trial.apply_count+'</span></div><div>费用<span class="color-black">'+trial.cat_str+'</span></div><div>剩余<span class="color-black" id="num_'+trial.id+'"></span></div><a/></li><li class="mui-table-view-cell li" style="padding-top:0;">'+txt+'</li></ul>');

					switch(status)
					{
						case 0:
						txt='<a class="block" style="background:#ccc;" href="trial-detail.html?trial_id='+infos[i].trial_id+'">等待审核</a>'
						break;
						case 1:
						txt='<a class="block" href="trial-detail.html?trial_id='+infos[i].trial_id+'#1">写试用体会</a>'
						str.addClass('act')
						break;
						case 2:
						txt='<a class="block" href="trial-detail.html?trial_id='+infos[i].trial_id+'#1">去下单</a>';
						str.addClass('act')
						break;    
						case 3:
						txt='<a class="block" href="trial-detail.html?trial_id='+infos[i].trial_id+'#1">去写试用体会</a>'
						break;
						case 4:
						txt='<a class="block" href="trial-detail.html?trial_id='+infos[i].trial_id+'#1">查看试用体会</a>'
						str.addClass('act')
						break;
						case 5:
						txt='<a class="block" style="background:#ccc;" href="trial-detail.html?trial_id='+infos[i].trial_id+'" >未获得试用</a>';
						str.addClass('cur');
						break;
						default:
							  // txt='已经评价'
							}							
							ding(trial.end_time,"#num_"+trial.id)
							str.find('.mui-table-view-cell.li').html(txt)
							$('#item3mobile').append(str);
							
						}
						
					},error:function(){
		//			alert()
		}
	});	
}



getAjax(1,'#item1mobile','tab1',offset1)
getAjax(2,'#item2mobile','tab2',offset2)
getTab3();//我的
//倒计时
function ding(end,id){
	var timeList = end.split(' ');;
	var riqi=timeList[0].split('-');
	console.log(riqi[0])
	var time=riqi[1]+'/'+riqi[2]+'/'+riqi[0]+' '+timeList[1];
	var end = new Date(time);
	var _second = 1000;
	var _minute = _second * 60;
	var _hour = _minute * 60;
	var _day = _hour * 24;
	var timer;
	function showRemaining() {
		var now = new Date();
		var distance = end - now;
            // console.log(111)
            if (distance < 0) {
            	clearInterval(timer);
                      // document.getElementById('countdown').innerHTML = 'EXPIRED!';
                      $(id).html('活动已经结束');
                      return;
                  }
                  var days = Math.floor(distance / _day);
                  var hours = Math.floor((distance % _day) / _hour);
                  var minutes = Math.floor((distance % _hour) / _minute);
                  var seconds = Math.floor((distance % _minute) / _second);
                  $(id).html(days + '天'+hours+'时'+minutes+'分'+seconds+'秒')
                    // console.log('仅剩'+days + '天'+hours+'时'+minutes+'分'+seconds+'秒') ;
                }
                timer = setInterval(showRemaining, 1000);			          	
            }	
            window.onscroll = function () { 
            	if (getScrollTop() + getClientHeight() == getScrollHeight()) { 
            		if(offset1){
            			getAjax(1,'#item1mobile','tab1',offset1)
            		}
            		if(offset2){
            			getAjax(2,'#item2mobile','tab2',offset2)
            		}
            		if(offset3){
            			
            			getTab3()
            		}
            	} 
            }
            
        </script>
    </body>
    </html>
